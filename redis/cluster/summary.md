> Redis集群是Redis提供的分布式数据库方案。

## 节点

一个Redis集群通常由多个节点组成，在刚开始的时候，每个节点都是独立的，它们都处于一个只包含自己的集群中，要组建一个真正的集群，我们可以通过使用cluster meet ip port命令，向一个节点发送cluster meet命令，可以让node节点和ip、port所代表的节点进行握手，握手成功的时候，node节点就会将ip、port代表的节点添加到node节点当前所在的集群中。

### 启动节点

Redis服务器在启动的时候会根据cluster-enabled配置选项是否为yes来决定是否开启服务器的集群模式。

集群节点会继续使用redisServer结构来保存服务器的状态，使用redisClient来保存客户端的状态，至于一些只有在集群模式下才会使用到的数据，节点将它们保存到了clusterNode、clusterLink以及clusterState结构里面。

### 集群数据结构

clusterNode保存了一个节点的当前状态，并为集群中的其他节点都创建一个clusterNode结构。

clusterNode结构中有一个link属性，它是一个clusterLink结构，该属性保存了连接节点所需的信息，比如套接字描述符，输入缓冲区和输出缓冲区。

最后，每个节点还保存了一个clusterState结构，这个结构记录了在当前的视角下，集群目前所处的状态。

### cluster meet命令的实现

B向A发送这个命令，收到命令的A将会和B进行握手，以此来确认彼此的存在。

握手完成之后，节点A会将节点B的信息通过Gossip协议传播给集群中的其他节点，让其他节点也与B进行握手，最终，经过一段时间后，节点B会被集群中的所有节点认识。

## 槽指派

Redis集群通过分片的方式来保存数据库中的键值对，集群中的整个数据库被分为16384个槽，数据库中的每个键都属于这些槽中的某一个，集群中的每个节点可以处理0个最多16384个槽。

当集群中的所有槽都有节点在处理时，集群处于上线状态，相反，集群中的任何一个槽没有被处理，那么集群处理下线状态。

clusterState中的slots数组记录了所有槽的指派信息。

## 在集群中执行命令

当客户端向集群发送和数据库键有关的命令时，接受命令的节点会计算出命令要处理的数据库键属于哪个槽，并检查这个槽是否指派给了自己。

* 如果键所指的槽正好指向了当前的节点，那么节点直接执行这个命令
* 键指向的槽没有指向当前节点，那么向客户端返回一个moved错误，指引客户端转向至正确的节点，并再次发送之前想要执行的命令。

节点和单机服务器在对数据库方面的一个区别是：节点直接使用0号数据库，而单机服务器没有这个限制。

## 重新分片

重新分片操作可以将任意数量已经指派给某个节点的槽改为指派给另一个节点，并且相关槽所属的键值对也会从源节点被移动到目标节点。

## ASK错误

当客户端向源节点发送一个与数据库键有关的命令时，并且命令要处理的数据库键恰好就属于正在被迁移的键时：

* 源节点现在自己的数据库槽里找这个键，找到的话直接处理这个命令
* 否则，向客户端返回一个ASK错误，指引客户端到正在导入槽的目标节点。

## 复制和故障转移

Redis集群中的节点分为主节点和从节点，其中主节点用于处理槽，从节点用于复制某个主节点，并在被复制的主节点下线的时候，代替下线主节点继续处理命令请求。

主节点转移和重新选举。
