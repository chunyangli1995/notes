> Sentinel是redis的一个高可用解决方案。

Sentinel集群会监测主服务器的状态，当主服务器下线并且超过一定时间之后，Sentinel就会对主服务器执行故障转移操作。

* 在剩下的从服务器中挑选一个作为主服务器
* 向现在的所有的从服务器发送复制命令，让他们成为新的主服务器的从服务器。
* Sentinel会监视下线的主服务器，当它重新上线后，设置为新的主服务器的从服务器。

## 启动并初始化Sentinel

### 初始化服务器

Sentinel的本质就是一个运行在特殊模式下的redis服务器，所以第一步就是初始化一个普通的redis服务器，但是Sentinel服务器的启动和普通redis服务器的启动还有所差别，

### 使用Sentinel的专用代码

将一部分redis服务器使用的代码替换成Sentinel专用的代码，这也是在Sentinel模式下一些命令不能使用的原因。

### 初始化Sentinel状态

服务器会初始化一个sentinelState结构，这个结构保存了服务器中所有和Sentinel功能有关的状态。

### 初始化Sentinel状态中的masters属性

Sentinel状态中的masters字典记录了所有被Sentinel监视的主服务器的相关信息，其中：

* 字典的键是被监视的主服务器的名字
* 字典的值是对应的sentinelRedisInstance结构

### 创建连接向主服务器的网络连接

Sentinel将成为主服务器的客户端，它可以向主服务器发送命令，并从命令回复中获取相关的信息。

对于每个被Sentinel来说，Sentinel会创建两个连向主服务器的异步网络连接。

* 一个是命令连接，这个连接专门用于向主服务器发送命令，并接受命令回复。
* 另一个是订阅连接，这个连接专门用于订阅主服务器的__sentinel\__:hello频道

## 获取主服务器的信息

Sentinel默认10s一次的频率向被监视的主服务器发送info命令，并通过分析info命令的回复来获取主服务器的当前信息。

## 获取从服务器的信息

当Sentinel发现主服务器有新的从服务器出现时，Sentinel除了会为这个新的从服务器创建相应的实例结构之外，还会创建连接到从服务器的命令连接和订阅连接。

## 向主服务器和从服务器发送信息

默认情况下，Sentinel会以两秒每次的频率，通过命令连接向所有被监视的主服务器和从服务器发送命令到__sentinel\__:hello频道，内容有两个参数组成：

* Sentinel本身的信息
* m_开头的信息是服务器的信息，如果件事的是主服务器，那么这个参数表示的就是主服务器的信息，否则就是从服务器的信息。

## 接受来自主服务器和从服务器的频道信息

对于每个和Sentinel连接的服务器，Sentinel既通过命令连接向服务器的\__sentinel\__:hello频道发送信息，又通过订阅连接从服务器的__sentinel\__:hello频道接受信息。

## 更新sentinels字典

Sentinel为主服务器创建的实例结构中的sentinels字典保存了除sentinel本身之外，所有同样监视这个主服务器的其他sentinel的信息。

## 创建向其他sentinel的信息

当sentinel通过频道发现一个新的sentinel时，它不仅会为新sentinel在sentinels字典中创建相应的实例结构，还会创建一个连向新的sentinel的连接，而新的sentinel也同样会创建连接向这个sentinel的连接，最终监视同一个主服务器的sentinel将成为一个互相连接的网络。

## 检测主观下线状态

默认情况下，sentinel会以每秒一次的频率向所有与它创建了命令连接的实例发送ping命令，并通过实例返回的ping命令判断实例是否在线。

Sentinel配置文件中的down-after-millisecond选项指定了sentinel判断主观下线所需的时间长度，如果一个实例在down-after-millisecond毫秒内，连续向sentinel返回无效回复，那么sentinel会更新这个实例对应的实例结构，标记这个实例为主观下线状态。

多个sentinel实例设置的主观下线时长可能还不一样。

## 检查客观下线状态

当sentinel将一个服务器标记为主观下线状态之后，为了确认这个主服务器是否真的下线了，它会向同样监视这一主服务器的其他sentinel询问，当sentinel从其他的sentinel那里获得足够多的主观下线判断之后，sentinel就会认为主服务器客观下线，并进行对应的故障转移操作。

## 故障转移

1. 选出新的主服务器
2. 修改从服务器的复制目标
3. 将旧的主服务器变为从服务器