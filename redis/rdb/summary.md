## 数据的持久化

Redis的数据都是保存在内存中，如果服务器进程一但退出了，服务器中的数据库状态（指非空数据库及其中的键值对）就会消失不见，所以我们必须采取一些措施能够将数据保存到磁盘上，避免数据的意外丢失。RDB就是一种保存数据的方式。

## RDB文件的创建和载入

SAVE和BESAVE命令可以生成RDB文件，SAVE命令会**阻塞**redis服务器进程，直到文件创建完毕，否则服务器不能处理任何命令请求。

BESAVE和SAVE命令不同的地方是前者会派生出一个子进程，然后子进程负责创建RDB文件，服务器进程继续处理命令请求。

RDB载入是在服务器启动时自动执行的，只要redis服务器在启动时检测到RDB文件存在，它就会自动载入RDB文件。

因为AOF文件的更新频率通常比RDB文件的更新频率高，所以：

* 如果服务器开启了AOF持久化功能，服务器会优先使用AOF文件来还原数据库的状态
* 只有在AOF持久化功能关闭的时候，服务器才会使用RDB文件来还原数据库状态

## BGSAVE命令执行时的服务器状态

执行期间，服务器可以接受客户端的请求，但是处理SAVE、BESAVE、BGREWRITEAOF三个命令的方式会和平时不同。前两个命令会被直接拒绝掉，第三个会等到BESAVE执行完毕后再执行。

BESAVE和BGREWRITEAOF不能同时执行

* 前者执行时接收到后者命令会等到前者执行完毕，再去执行后者
* 后者执行时接收到前者命令会拒绝前者

## 服务器载入RDB文件时

会一直阻塞

## RDB文件生成的频次可配置

服务端会记录dirty属性和lastsave属性，前者表示上一次执行SAVE或者BESAVE后，服务器对数据库状态做了多少次修改。lastsave属性记录了服务端上一次执行SAVE或者BESAVE的时间戳。

**服务端默认每100ms执行一次，查看SAVE或者BESAVE的执行条件是否满足**

## RDB文件的结构

### 开头
RDB文件的开头是REDIS五个字符，程序可以在载入RDB文件的时候，快速判断载入的文件是否是RDB文件。

### db_version
这个整数记录了RDB文件的版本号。

### database

包含了0个或者多个数据库，以及各个数据库中的键值对。

### EOF常量
长度为一个字节，表示RDB文件正文内容的结束。

### checkout_sum
是一个八字节长的无符号整数，保存着一个校验和，这个校验和是程序通过对前四个部分的内容进行计算获得的，服务器在进行RDB文件载入时，会通过计算校验和来判断RDB文件是否有损坏的情况。



