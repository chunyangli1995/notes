## 命令请求的执行过程

### 发送命令请求

当用户在客户端输入一个命令时，客户端会将这个命令请求转换成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器。

### 读取命令请求

1. 读取套接字协议格式中的命令请求，并将其保存到客户端状态的输入缓冲区里面
2. 对输入缓冲区中的命令进行分析，提取出命令请求中包含的命令参数，以及命令参数的个数，然后分别将参数和参数个数设置到客户端状态的argv和argc属性中。
3. 调用命令执行器，执行客户端指定的命令。

### 命令执行器一：查找命令实现

首先根据客户端的状态的argv[0]参数，在命令表中查找参数所指定的命令，并将找到的命令保存到客户端状态的cmd属性里面。

命令表的键就是命令名称，值指向一个RedisCommand结构。

### 命令执行器二：执行预备操作

这一步主要是进行一些预备检查工作，从而确保命令可以正确、顺利的被执行。

### 命令执行器三：调用命令的实现函数

前面的操作中，服务器已经将要执行命令的实现保存到了客户端状态的cmd属性里面，并将命令的参数和参数个数保存到了argv、argc里面，接下来只要执行下面的命令就可以：

client->cmd->proc(client)

### 命令执行器四：执行后续工作

执行完命令之后，服务器还需要执行一些后续工作：

* 慢查询日志记录
* 记录命令耗时，记录在RedisCommand的milliseconds属性中，并将RedisCommand的calls属性+1
* 如果服务器开启了aof功能，aof持久化模块会把刚执行的命令写入到aof缓冲区中
* 如果有其他从服务器正在复制当前这个服务器，那么服务器会将刚刚执行的命令传播给所有从服务器

### 命令回复传回客户端

### 客户端接收并打印

接收回复，并转换成人类可读的形式。

## serverCron函数

默认每隔100ms执行一次，这个函数负责管理服务器的资源，并保持服务器自身的良好运转。

### 更新服务器时间缓存

### 更新LRU时间

### 更新服务器每秒执行的命令的次数

### 更新服务器内存峰值状态

### 处理SIGTERM信号

### 管理客户端资源

* 如果客户端和服务端的连接已经超时，那么程序释放这个客户端
* 如果客户端上次执行命令请求之后，输入缓冲区的大小超过了一定长度，那么程序会释放客户端当前的输入缓冲区，并重新创建一个默认大小的输入缓冲区

### 管理数据库资源

对一部分数据库进行检查，删除过期键，并在有需要的时候，对字典进行收缩

### 执行被延迟的BGREWRITEAOF

### 检查持久化操作的运行状态

### 将aof缓冲区中的内容写入aof缓冲区

### 关闭异步客户端

### 增加cronloops计数器的值

记录了serverCron函数被执行的次数

## 初始化服务器

### 初始化服务器状态结构
### 载入配置选项
### 初始化服务器数据结构
### 还原数据库状态
### 执行事件循环