>Redis命令可以使用slaveof命令或者设置slaveof选项，让一个服务器去复制另一个服务器，我们称被复制的服务器为主服务器，而对主服务器进行复制的称为从服务器。

## 旧版复制功能的实现

### 同步

当客户端从服务器发送slaveof命令，要求从服务器复制主服务器时，从服务器首先要执行同步操作，也即是，将从服务器的数据库状态更新至主服务器当前所属的服务器状态。

sync步骤：

* 从服务器向主服务器发送sync命令
* 收到sync命令的主服务器执行besave命令，在后台生成一个rdb文件，并使用一个缓冲区记录从现在开始执行所有写命令
* 当主服务器的besave命令执行完毕时，主服务器会将besave命令生成的rdb文件发送给从服务器，从服务器接受并载入这个rdb文件，将自己的数据库状态更新至主服务器执行besave时的数据库状态
* 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器接受写命令，将自己的数据库状态更新至主服务器数据库当前所属的状态

###  命令传播

主服务器需要对从服务器执行命令传播操作，主服务器会将自己执行的写命令，也就是造成主从服务器不一致的那条写命令，发送给从服务器执行。

### 旧版复制的缺陷

断线后重新复制，从服务器重新连接之后，会再一次发送sync命令，主服务器会将rdb文件再一次传给从服务器，但实际上断线的这段时间，可能从服务器缺失的可能只是短短几条命令，因为几条命令，就要重新载入一遍整个rdb文件，这样的效率显然是很低下的。


## 新版复制功能的实现

>Redis2.8之后使用psync代替sync。

psync有完整重同步和部分重同步两种模式：

* 完整重同步用于处理初次复制情况，完整重同步的执行步骤和sync的执行步骤基本一样。
* 部分重同步用于处理断线后复制情况，当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接受并且执行这些写命令，就可以将数据库更新至主服务器当前所处的状态。

### 部分重同步的实现

#### 复制偏移量

执行复制操作的双方，主服务器和从服务器分别维护一个复制偏移量。

* 主服务器每次向从服务器传播N个字节的数据的时候，就把自己的复制偏移量的值加上N
* 从服务器每次接收到主服务器传播来的N个字节的数据的时候，就把自己的复制偏移量的值加上N

通过对比主从服务器的复制偏移量，可以较容易的判断一致性状态：

* 如果主从服务器处于一致性状态，那么主从服务器两者的偏移量总是相同的
* 偏移量如果不相同，那么说明主从服务器处于不一致的状态

#### 复制挤压缓冲区

由主服务器维护的一个FIFO的队列，默认大小为1MB。

当主服务器进行命令传播的时候，它不仅会将所有的命令发送给从服务器，还会将写命令入队到复制积压缓冲区里面

因此，这个缓冲区里面保存着一部分最近传播的写命令，并且复制积压缓冲区会为队列中的每个字节记录相应的复制偏移量。

当从服务器重新连上主服务器的时候，从服务器会通过psync来将自己的复制偏移量发送给主服务器，主服务器根据这个偏移量来决定进行何种操作。

#### 服务器运行id

实现部分重同步还需要服务器运行id。

* 每个redis服务器，不管是主服务器还是从服务器，都会有自己的运行id。
* 运行id在服务器启动时自动生成。

当从服务器断线并且重新连上一个主服务器的时候，从服务器向当前连接的主服务器发送运行id：

* 如果id相同，说明从服务器断线之前连接的就是这个主服务器，那么可以执行部分重同步。
* 如果id不相同，说明从服务器断线之前连接的不是这个主服务器，那么执行完全重同步。

## 复制的实现

1. 设置主服务器的地址和端口
2. 建立连接套接字
3. 发送ping命令
4. 身份验证
5. 发送端口
6. 同步
7. 命令传播

### 心跳检测

主要是三个作用

1. 检测主从服务器的连接状态
2. 辅助实现min-slaves选项
3. 检测命令丢失